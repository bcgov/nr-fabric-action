name: Fabric Deployment Pipeline

on:
  push:
    branches:
      - "feature/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  WS_PREFIX: feat
  VAR_PREFIX: ENV_VARS
  APPROVER: Data-Alchemy

  DEV_CAPACITY_ID: ${{ vars.DEV_CAPACITY_ID }}
  TEST_CAPACITY_ID: ${{ vars.TEST_CAPACITY_ID }}
  PROD_CAPACITY_ID: ${{ vars.PROD_CAPACITY_ID }}
  DEV_WORKSPACE_ID: ${{ vars.DEV_WORKSPACE_ID }}
  TEST_WORKSPACE_ID: ${{ vars.TEST_WORKSPACE_ID }}
  PROD_WORKSPACE_ID: ${{ vars.PROD_WORKSPACE_ID }}
  GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
  GITHUB_REPOSITORY_OWNER: ${{ github.event.repository.owner.login }}
  FABRIC_VAR_FILE_PATH: variable_template.VariableLibrary/variables.json
  FABRIC_CONNECTION_ID: ${{ vars.FABRIC_CONNECTION_ID }}
  WORKSPACE_ADMIN_ID: ${{ vars.WORKSPACE_ADMIN_ID }}

jobs:
  # ══════════════════════════════════════════════════════════════
  # 0. Validate Service Principal Permissions
  # ══════════════════════════════════════════════════════════════
  check-spn-permissions:
    name: "0. Validate SPN Permissions"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x ./.github/workflows/scripts/spn_evaluator.sh

      - name: Run SPN Evaluator
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          ./.github/workflows/scripts/spn_evaluator.sh --output table

  # ══════════════════════════════════════════════════════════════
  # 1. Create Feature Workspace
  # ══════════════════════════════════════════════════════════════
  create-feature-workspace:
    name: "1. Create Feature Workspace"
    needs: [check-spn-permissions]
    uses: ./.github/workflows/create-fabric-workspace.yml
    with:
      branch-name: ${{ github.ref_name }}
      workspace-prefix: feat
      capacity-id: ${{ vars.DEV_CAPACITY_ID }}
      git-branch: ${{ github.ref_name }}
      fabric-connection-id: ${{ vars.FABRIC_CONNECTION_ID }}
      workspace-admin-id: ${{ vars.WORKSPACE_ADMIN_ID }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # ══════════════════════════════════════════════════════════════
  # 2. Update Variables for Dev Environment
  # ══════════════════════════════════════════════════════════════
  update-dev-variables:
    name: "2. Update Dev Variables"
    needs: [create-feature-workspace]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Update variables.json for Dev
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          chmod +x ./.github/workflows/scripts/update_variables.sh
          ./.github/workflows/scripts/update_variables.sh \
            -p ${{ env.VAR_PREFIX }} \
            -e DEV \
            -f ${{ env.FABRIC_VAR_FILE_PATH }} \
            -r ${{ github.repository }}

      - name: Commit and push variables.json only
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet ${{ env.FABRIC_VAR_FILE_PATH }}; then
            echo "No changes to variables.json"
          else
            git add ${{ env.FABRIC_VAR_FILE_PATH }}
            git commit -m "chore: update variables.json for dev environment [skip ci]"
            git push
          fi

  # ══════════════════════════════════════════════════════════════
  # 4. Deploy to Dev Workspace
  # ══════════════════════════════════════════════════════════════
  deploy-to-dev:
    name: "4. Deploy to Dev"
    needs: [update-dev-variables]
    uses: ./.github/workflows/update-workspace-git.yml
    with:
      workspace-id: ${{ vars.DEV_WORKSPACE_ID }}
      fabric-connection-id: ${{ vars.FABRIC_CONNECTION_ID }}
      git-branch: ${{ github.ref_name }}
    secrets:
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

  # ══════════════════════════════════════════════════════════════
  # 5. Merge to Dev Branch and Update Test Variables
  # ══════════════════════════════════════════════════════════════
  update-test-variables:
    name: "5. Update Test Variables"
    needs: [deploy-to-dev]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge feature branch into dev (prefer ours on conflict)
        run: |
          git fetch origin ${{ github.ref_name }}
          git merge origin/${{ github.ref_name }} --no-edit || {
            # Handle all conflicts using "ours" strategy (prefer current branch - dev)
            echo "Merge conflicts detected. Resolving with 'ours' strategy..."
            git checkout --ours .
            git add .
            git commit --no-edit || true
          }

      - name: Update variables.json for Test
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          chmod +x ./.github/workflows/scripts/update_variables.sh
          ./.github/workflows/scripts/update_variables.sh \
            -p ${{ env.VAR_PREFIX }} \
            -e TEST \
            -f ${{ env.FABRIC_VAR_FILE_PATH }} \
            -r ${{ github.repository }}

      - name: Commit and push to dev branch
        run: |
          if git diff --quiet ${{ env.FABRIC_VAR_FILE_PATH }}; then
            echo "No changes to variables.json"
          else
            git add ${{ env.FABRIC_VAR_FILE_PATH }}
            git commit -m "chore: update variables.json for test environment [skip ci]"
          fi
          git push origin dev

  # ══════════════════════════════════════════════════════════════
  # 6. Wait for Test Approval
  # ══════════════════════════════════════════════════════════════
  wait-for-test-approval:
    name: "6. Wait for Test Approval"
    needs: [update-test-variables]
    runs-on: ubuntu-latest
    steps:
      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ env.APPROVER }}
          minimum-approvals: 1
          issue-title: "Deploy to Test Environment"
          issue-body: "Please approve deployment to Test workspace"

  # ══════════════════════════════════════════════════════════════
  # 7. Deploy to Test Workspace
  # ══════════════════════════════════════════════════════════════
  deploy-to-test:
    name: "7. Deploy to Test"
    needs: [wait-for-test-approval]
    uses: ./.github/workflows/update-workspace-git.yml
    with:
      workspace-id: ${{ vars.TEST_WORKSPACE_ID }}
      fabric-connection-id: ${{ vars.FABRIC_CONNECTION_ID }}
      git-branch: dev
    secrets:
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

  # ══════════════════════════════════════════════════════════════
  # 8. Merge to Test Branch and Update Prod Variables
  # ══════════════════════════════════════════════════════════════
  update-prod-variables:
    name: "8. Update Prod Variables"
    needs: [deploy-to-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout test branch
        uses: actions/checkout@v4
        with:
          ref: test
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge dev branch into test (prefer ours on conflict)
        run: |
          git fetch origin dev
          git merge origin/dev --no-edit || {
            # Handle all conflicts using "ours" strategy (prefer current branch - test)
            echo "Merge conflicts detected. Resolving with 'ours' strategy..."
            git checkout --ours .
            git add .
            git commit --no-edit || true
          }

      - name: Update variables.json for Production
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          chmod +x ./.github/workflows/scripts/update_variables.sh
          ./.github/workflows/scripts/update_variables.sh \
            -p ${{ env.VAR_PREFIX }} \
            -e PROD \
            -f ${{ env.FABRIC_VAR_FILE_PATH }} \
            -r ${{ github.repository }}

      - name: Commit and push to test branch
        run: |
          if git diff --quiet ${{ env.FABRIC_VAR_FILE_PATH }}; then
            echo "No changes to variables.json"
          else
            git add ${{ env.FABRIC_VAR_FILE_PATH }}
            git commit -m "chore: update variables.json for production environment [skip ci]"
          fi
          git push origin test

  # ══════════════════════════════════════════════════════════════
  # 9. Wait for Production Approval
  # ══════════════════════════════════════════════════════════════
  wait-for-prod-approval:
    name: "9. Wait for Production Approval"
    needs: [update-prod-variables]
    runs-on: ubuntu-latest
    steps:
      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ env.APPROVER }}
          minimum-approvals: 2
          issue-title: "Deploy to Production Environment"
          issue-body: "Please approve deployment to Production workspace"

  # ══════════════════════════════════════════════════════════════
  # 10. Merge to Main and Deploy to Production
  # ══════════════════════════════════════════════════════════════
  merge-to-main:
    name: "10. Merge to Main"
    needs: [wait-for-prod-approval]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge test branch into main (prefer ours on conflict)
        run: |
          git fetch origin test
          git merge origin/test --no-edit || {
            # Handle all conflicts using "ours" strategy (prefer current branch - main)
            # This ensures production gets the latest changes from test
            echo "Merge conflicts detected. Resolving with 'ours' strategy..."
            git checkout --ours .
            git add .
            git commit --no-edit || true
          }
          git push origin main

  deploy-to-prod:
    name: "11. Deploy to Production"
    needs: [merge-to-main]
    uses: ./.github/workflows/update-workspace-git.yml
    with:
      workspace-id: ${{ vars.PROD_WORKSPACE_ID }}
      fabric-connection-id: ${{ vars.FABRIC_CONNECTION_ID }}
      git-branch: main
    secrets:
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
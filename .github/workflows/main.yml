name: Fabric Deployment Pipeline

on:
  push:
    branches:
      - "feature/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  WS_PREFIX: feat
  VAR_PREFIX: env_var
  APPROVER: Data-Alchemy

  DEV_CAPACITY_ID: ${{ vars.DEV_CAPACITY_ID }}
  TEST_CAPACITY_ID: ${{ vars.TEST_CAPACITY_ID }}
  PROD_CAPACITY_ID: ${{ vars.PROD_CAPACITY_ID }}
  DEV_WORKSPACE_ID: ${{ vars.DEV_WORKSPACE_ID }}
  TEST_WORKSPACE_ID: ${{ vars.TEST_WORKSPACE_ID }}
  PROD_WORKSPACE_ID: ${{ vars.PROD_WORKSPACE_ID }}
  GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
  GITHUB_REPOSITORY_OWNER: ${{ github.event.repository.owner.login }}
  FABRIC_VAR_FILE_PATH: variable_template.VariableLibrary/variables.json
  FABRIC_CONNECTION_ID: ${{ vars.FABRIC_CONNECTION_ID }}
  WORKSPACE_ADMIN_ID: ${{ vars.WORKSPACE_ADMIN_ID }}

jobs:
  # ══════════════════════════════════════════════════════════════
  # 0. Validate Service Principal Permissions
  # ══════════════════════════════════════════════════════════════
  check-spn-permissions:
    name: "0. Validate SPN Permissions"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x ./.github/workflows/scripts/spn_evaluator.sh

      - name: Run SPN Evaluator
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          ./.github/workflows/scripts/spn_evaluator.sh --output table

  # ══════════════════════════════════════════════════════════════
  # 1. Create Feature Workspace
  # ══════════════════════════════════════════════════════════════
  create-feature-workspace:
    name: "1. Create Feature Workspace"
    needs: [check-spn-permissions]
    uses: ./.github/workflows/create-fabric-workspace.yml
    with:
      branch-name: ${{ github.ref_name }}
      workspace-prefix: feat
      capacity-id: ${{ vars.DEV_CAPACITY_ID }}
      git-branch: ${{ github.ref_name }}
      fabric-connection-id: ${{ vars.FABRIC_CONNECTION_ID }}
      workspace-admin-id: ${{ vars.WORKSPACE_ADMIN_ID }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # ══════════════════════════════════════════════════════════════
  # 2. Update Variables for Dev Environment
  # ══════════════════════════════════════════════════════════════
  update-dev-variables:
    name: "2. Update Dev Variables"
    needs: [create-feature-workspace]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update variables.json for Dev
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./.github/workflows/scripts/update_variables.sh
          ./.github/workflows/scripts/update_variables.sh \
            -p ${{ env.VAR_PREFIX }} \
            -e dev \
            -f ${{ env.FABRIC_VAR_FILE_PATH }} \
            -r ${{ github.repository }}

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add ${{ env.FABRIC_VAR_FILE_PATH }}
            git commit -m "chore: update variables.json for dev environment [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi

  # ══════════════════════════════════════════════════════════════
  # 3. Wait for Dev Approval
  # ══════════════════════════════════════════════════════════════
  # no approval step for dev deploys 
  # wait-for-dev-approval:
  #   name: "3. Wait for Dev Approval"
  #   needs: [update-dev-variables]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: trstringer/manual-approval@v1
  #       with:
  #         secret: ${{ github.TOKEN }}
  #         approvers: ${{ env.APPROVER }}
  #         minimum-approvals: 1
  #         issue-title: "Deploy to Dev Environment"
  #         issue-body: "Please approve deployment to Dev workspace"

  # ══════════════════════════════════════════════════════════════
  # 4. Deploy to Dev Workspace
  # ══════════════════════════════════════════════════════════════
  deploy-to-dev:
    name: "4. Deploy to Dev"
    needs: [update-dev-variables]
    uses: ./.github/workflows/update-workspace-git.yml
    with:
      workspace-id: ${{ vars.DEV_WORKSPACE_ID }}
      fabric-connection-id: ${{ vars.FABRIC_CONNECTION_ID }}
      git-branch: ${{ github.ref_name }}
    secrets:
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

  # ══════════════════════════════════════════════════════════════
  # 5. Update Variables for Test Environment
  # ══════════════════════════════════════════════════════════════
  update-test-variables:
    name: "5. Update Test Variables"
    needs: [deploy-to-dev]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update variables.json for Test
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./.github/workflows/scripts/update_variables.sh
          ./.github/workflows/scripts/update_variables.sh \
            -p ${{ env.VAR_PREFIX }} \
            -e test \
            -f ${{ env.FABRIC_VAR_FILE_PATH }} \
            -r ${{ github.repository }}

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add ${{ env.FABRIC_VAR_FILE_PATH }}
            git commit -m "chore: update variables.json for test environment [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi

  # ══════════════════════════════════════════════════════════════
  # 6. Wait for Test Approval
  # ══════════════════════════════════════════════════════════════
  wait-for-test-approval:
    name: "6. Wait for Test Approval"
    needs: [update-test-variables]
    runs-on: ubuntu-latest
    steps:
      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ env.APPROVER }}
          minimum-approvals: 1
          issue-title: "Deploy to Test Environment"
          issue-body: "Please approve deployment to Test workspace"

  # ══════════════════════════════════════════════════════════════
  # 7. Deploy to Test Workspace
  # ══════════════════════════════════════════════════════════════
  deploy-to-test:
    name: "7. Deploy to Test"
    needs: [wait-for-test-approval]
    uses: ./.github/workflows/update-workspace-git.yml
    with:
      workspace-id: ${{ vars.TEST_WORKSPACE_ID }}
      fabric-connection-id: ${{ vars.FABRIC_CONNECTION_ID }}
      git-branch: ${{ github.ref_name }}
    secrets:
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

  # ══════════════════════════════════════════════════════════════
  # 8. Update Variables for Production Environment
  # ══════════════════════════════════════════════════════════════
  update-prod-variables:
    name: "8. Update Prod Variables"
    needs: [deploy-to-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update variables.json for Production
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./.github/workflows/scripts/update_variables.sh
          ./.github/workflows/scripts/update_variables.sh \
            -p ${{ env.VAR_PREFIX }} \
            -e prod \
            -f ${{ env.FABRIC_VAR_FILE_PATH }} \
            -r ${{ github.repository }}

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add ${{ env.FABRIC_VAR_FILE_PATH }}
            git commit -m "chore: update variables.json for production environment [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi

  # ══════════════════════════════════════════════════════════════
  # 9. Wait for Production Approval
  # ══════════════════════════════════════════════════════════════
  wait-for-prod-approval:
    name: "9. Wait for Production Approval"
    needs: [update-prod-variables]
    runs-on: ubuntu-latest
    steps:
      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ env.APPROVER }}
          minimum-approvals: 2
          issue-title: "Deploy to Production Environment"
          issue-body: "Please approve deployment to Production workspace"

  # ══════════════════════════════════════════════════════════════
  # 10. Deploy to Production Workspace
  # ══════════════════════════════════════════════════════════════
  deploy-to-prod:
    name: "10. Deploy to Production"
    needs: [wait-for-prod-approval]
    uses: ./.github/workflows/update-workspace-git.yml
    with:
      workspace-id: ${{ vars.PROD_WORKSPACE_ID }}
      fabric-connection-id: ${{ vars.FABRIC_CONNECTION_ID }}
      git-branch: ${{ github.ref_name }}
    secrets:
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
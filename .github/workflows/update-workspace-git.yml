# .github/workflows/update-workspace-git.yml
name: Update Workspace Git Integration

on:
  workflow_call:
    inputs:
      workspace-id:
        required: true
        type: string
        description: 'Workspace ID to update'
      git-branch:
        required: true
        type: string
        description: 'Git branch to pull from'
      fabric-connection-id:
        required: true
        type: string
        description: 'Fabric GitHub connection ID'
    secrets:
      tenant-id:
        required: true
      client-id:
        required: true
      client-secret:
        required: true

jobs:
  update-workspace:
    name: Update Workspace
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Get Fabric API Token
        id: get-token
        env:
          TENANT_ID: ${{ secrets.tenant-id }}
          CLIENT_ID: ${{ secrets.client-id }}
          CLIENT_SECRET: ${{ secrets.client-secret }}
        run: |
          set -euo pipefail

          : "${TENANT_ID:?TENANT_ID is empty}"
          : "${CLIENT_ID:?CLIENT_ID is empty}"
          : "${CLIENT_SECRET:?CLIENT_SECRET is empty}"

          TOKEN_URL="https://login.microsoftonline.com/${TENANT_ID}/oauth2/v2.0/token"

          RESPONSE=$(curl -sS -X POST "$TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "client_id=${CLIENT_ID}" \
            --data-urlencode "client_secret=${CLIENT_SECRET}" \
            --data-urlencode "scope=https://api.fabric.microsoft.com/.default" \
            --data-urlencode "grant_type=client_credentials")

          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')

          if [[ -z "$TOKEN" ]]; then
            echo "Error: Failed to get access token"
            echo "$RESPONSE" | jq '{error, error_description, trace_id, correlation_id}'
            exit 1
          fi

          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"
          echo "Successfully obtained access token"

      - name: Get Workspace Git Status
        id: git-status
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"

          echo "Getting Git status for workspace: ${{ inputs.workspace-id }}"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
            "${FABRIC_API_URL}/workspaces/${{ inputs.workspace-id }}/git/status" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ Git status retrieved successfully"
            echo "$BODY" | jq '.'

            IS_CONNECTED=$(echo "$BODY" | jq -r '.gitConnectionState // "NotConnected"')
            echo "git_connected=$IS_CONNECTED" >> "$GITHUB_OUTPUT"
          else
            echo "⚠ Warning: Could not get Git status. HTTP Code: $HTTP_CODE"
            echo "$BODY" | jq '.' || echo "$BODY"
            echo "git_connected=NotConnected" >> "$GITHUB_OUTPUT"
          fi

      - name: Connect Workspace to Git
        if: steps.git-status.outputs.git_connected == 'NotConnected'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"

          echo "Connecting workspace to Git repository..."
          echo "Connecting workspace to Git..."
          echo "Workspace ID: ${{ inputs.workspace-id }}"
          echo "Connection ID: ${{ inputs.fabric-connection-id }}"
          echo "Branch: ${{ inputs.git-branch }}"


          PAYLOAD=$(cat <<EOF
          {
            "gitProviderDetails": {
              "gitProviderType": "GitHub",
              "ownerName": "${{ github.repository_owner }}",
              "repositoryName": "${{ github.event.repository.name }}",
              "branchName": "${{ inputs.git-branch }}",
              "directoryName": "/"
            },
            "myGitCredentials": {
              "source": "ConfiguredConnection",
              "connectionId": "${{ inputs.fabric-connection-id }}"
            }
          }
          EOF
          )


          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${{ inputs.workspace-id }}/git/connect" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ Workspace connected to Git successfully"
          else
            echo "✗ Failed to connect workspace to Git. HTTP Code: $HTTP_CODE"
            echo "$BODY" | jq '.' || echo "$BODY"
            exit 1
          fi

      - name: Initialize Git Connection
        id: init
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Initializing Git connection for workspace: $WS"

          # Capture headers + body for LRO handling
          HEADERS_FILE="$(mktemp)"
          BODY_FILE="$(mktemp)"

          HTTP_CODE=$(curl -sS -D "$HEADERS_FILE" -o "$BODY_FILE" -w "%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${WS}/git/initializeConnection" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{}")

          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "✓ Initialize completed (200)"
            cat "$BODY_FILE" | jq .
            echo "required_action=$(cat "$BODY_FILE" | jq -r '.requiredAction // empty')" >> "$GITHUB_OUTPUT"
            echo "remote_commit_hash=$(cat "$BODY_FILE" | jq -r '.remoteCommitHash // empty')" >> "$GITHUB_OUTPUT"
            echo "workspace_head=$(cat "$BODY_FILE" | jq -r '.workspaceHead // empty')" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$HTTP_CODE" == "202" ]]; then
            OP_ID=$(grep -i '^x-ms-operation-id:' "$HEADERS_FILE" | awk '{print $2}' | tr -d '\r')
            RETRY=$(grep -i '^retry-after:' "$HEADERS_FILE" | awk '{print $2}' | tr -d '\r')
            [[ -z "$RETRY" ]] && RETRY=10

            echo "....Initialize is running (operationId=$OP_ID). Polling every ${RETRY}s..."

            # Poll LRO state
            while true; do
              STATE=$(curl -sS -X GET \
                "${FABRIC_API_URL}/operations/${OP_ID}" \
                -H "Authorization: Bearer $FABRIC_TOKEN" \
                -H "Content-Type: application/json" | jq -r '.status')

              echo "LRO status: $STATE"
              if [[ "$STATE" == "Succeeded" ]]; then
                break
              elif [[ "$STATE" == "Failed" ]]; then
                curl -sS -X GET "${FABRIC_API_URL}/operations/${OP_ID}" \
                  -H "Authorization: Bearer $FABRIC_TOKEN" \
                  -H "Content-Type: application/json" | jq .
                exit 1
              fi
              sleep "$RETRY"
            done

            # Get LRO result (initializeConnection returns requiredAction + hashes)
            RESULT=$(curl -sS -X GET \
              "${FABRIC_API_URL}/operations/${OP_ID}/result" \
              -H "Authorization: Bearer $FABRIC_TOKEN" \
              -H "Content-Type: application/json")

            echo "✓ Initialize result:"
            echo "$RESULT" | jq .

            echo "required_action=$(echo "$RESULT" | jq -r '.requiredAction // empty')" >> "$GITHUB_OUTPUT"
            echo "remote_commit_hash=$(echo "$RESULT" | jq -r '.remoteCommitHash // empty')" >> "$GITHUB_OUTPUT"
            echo "workspace_head=$(echo "$RESULT" | jq -r '.workspaceHead // empty')" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "✗ Initialize failed. HTTP $HTTP_CODE"
          cat "$BODY_FILE" | jq . || cat "$BODY_FILE"
          exit 1

      - name: Update Git Branch
        if: steps.git-status.outputs.git_connected != 'NotConnected'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"

          echo "Updating workspace to branch: ${{ inputs.git-branch }}"

          PAYLOAD=$(cat <<EOF
          {
            "branchName": "${{ inputs.git-branch }}"
          }
          EOF
          )

          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            "${FABRIC_API_URL}/workspaces/${{ inputs.workspace-id }}/git/updateConnection" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ Git branch updated successfully"
          else
            echo "⚠ Warning: Failed to update branch. HTTP Code: $HTTP_CODE"
            echo "$BODY" | jq '.' || echo "$BODY"
          fi

      - name: Commit to Workspace
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"

          echo "Committing changes from workspace to Git..."

          PAYLOAD=$(cat <<EOF
          {
            "mode": "All",
            "comment": "Automated commit from workspace - ${{ github.sha }}"
          }
          EOF
          )

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${{ inputs.workspace-id }}/git/commitToGit" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ Changes committed to Git successfully"
          else
            echo "⚠ Info: No changes to commit or commit failed. HTTP Code: $HTTP_CODE"
            echo "$BODY" | jq '.' || echo "$BODY"
          fi

      - name: Update from Git
        if: steps.init.outputs.required_action == 'UpdateFromGit'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"

          echo "Updating workspace from Git using initialization hashes..."
          PAYLOAD=$(cat <<EOF
          {
            "remoteCommitHash": "${{ steps.init.outputs.remote_commit_hash }}",
            "workspaceHead": "${{ steps.init.outputs.workspace_head }}"
          }
          EOF
          )

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${{ inputs.workspace-id }}/git/updateFromGit" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ UpdateFromGit accepted/succeeded"
            echo "$BODY" | jq '.' || echo "$BODY"
          else
            echo "✗ UpdateFromGit failed. HTTP Code: $HTTP_CODE"
            echo "$BODY" | jq '.' || echo "$BODY"
            exit 1
          fi

      - name: Get Updated Git Status
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"

          echo "Getting updated Git status..."

          RESPONSE=$(curl -s -X GET \
            "${FABRIC_API_URL}/workspaces/${{ inputs.workspace-id }}/git/status" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json")

          echo "Current Git Status:"
          echo "$RESPONSE" | jq '.'

      - name: Summary
        run: |
          echo "### Workspace Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace ID**: ${{ inputs.workspace-id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Branch**: ${{ inputs.git-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**
